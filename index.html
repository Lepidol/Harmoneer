<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jaspearl Harmoneer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=JetBrains+Mono:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --periwinkle: #818cf8;
            --white: #ffffff;
            --void-bg: #010204;
            --panel-bg: rgba(6, 8, 18, 0.65); /* More transparent for frosted effect */
            --border-glow: rgba(129, 140, 248, 0.3);
        }

        body {
            background-color: var(--void-bg);
            color: #e2e8f0;
            overflow: hidden;
            touch-action: none;
            font-family: 'Space Grotesk', sans-serif;
            margin: 0;
            padding: 0;
        }

        /* --- Atmospheric Effects --- */
        body::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: radial-gradient(circle at center, transparent 0%, rgba(0,0,0,0.4) 100%); 
            z-index: 100;
            pointer-events: none;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            cursor: grab;
            position: relative;
            z-index: 1;
            will-change: transform; 
        }

        #canvas-container:active { cursor: grabbing; }

        #peripheral-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 5;
            background: radial-gradient(circle at center, transparent 30%, rgba(1, 4, 9, 0.5) 70%, #010204 100%);
            opacity: 0; 
            transition: opacity 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #peripheral-overlay.active { opacity: 1; }

        /* --- Node & Lattice Styling --- */
        .node-circle {
            fill: #010409; 
            stroke: var(--white);
            stroke-opacity: 0.6;
            stroke-width: 1.5px;
            transition: all 0.1s ease-out;
        }

        .connection-line {
            stroke: var(--white);
            stroke-opacity: 0.15;
            stroke-width: 1px;
            vector-effect: non-scaling-stroke; 
            pointer-events: none;
        }

        /* Special Node (Z-axis / 7th) */
        .node-special circle.node-circle {
            stroke-dasharray: 2 2;
            fill-opacity: 0.1;
        }

        /* Juicy Active State */
        .node-active circle.node-circle {
            stroke: currentColor !important; 
            fill: currentColor !important;
            fill-opacity: 0.25 !important; 
            stroke-width: 2px !important;
            stroke-opacity: 1 !important;
            filter: drop-shadow(0 0 5px currentColor) 
                    drop-shadow(0 0 15px currentColor) 
                    drop-shadow(0 0 30px currentColor) 
                    brightness(1.8);
        }
        
        .node-active .node-label {
            color: #ffffff !important; 
            font-weight: 900;
            text-shadow: 0 0 8px rgba(0,0,0,1), 0 0 15px currentColor;
            font-size: 12px;
        }

        .node-highlight circle.node-circle {
            stroke-width: 2.5px;
            stroke-opacity: 1;
        }

        .ghost-plane .connection-line {
            stroke-opacity: 0.05;
            stroke-dasharray: 4 4;
        }
        .ghost-plane .node-circle {
            stroke-opacity: 0.15;
        }

        .back-flat { display: inline-block; transform: scaleX(-1); }
        .half-sharp { font-weight: bold; }

        /* --- UI Panels (Frosted Glass HUD) --- */
        .hud-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(129, 140, 248, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            position: relative;
        }

        /* Default Corners (Top-Left / Bottom-Right) for bottom panels */
        .hud-panel.bottom-panel::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
        .hud-panel.bottom-panel::after { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; }
        .hud-panel.bottom-panel::before, .hud-panel.bottom-panel::after {
            content: ""; position: absolute; width: 12px; height: 12px;
            border-color: var(--periwinkle); border-style: solid; pointer-events: none; opacity: 0.8;
        }

        #ui-layer {
            position: absolute; bottom: 40px; left: 0; width: 100%;
            pointer-events: none; z-index: 200;
            display: flex; justify-content: center;
            align-items: flex-end;
            gap: 32px;
        }

        .panel-box {
            pointer-events: auto;
            border-radius: 2px;
            padding: 24px;
            display: flex; flex-direction: column; gap: 20px;
            transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            min-width: 300px; overflow: hidden;
        }

        .panel-box.minimized {
            min-width: 28px; width: 28px; max-height: 28px; height: 28px;
            padding: 0; border-radius: 50%;
            justify-content: center; align-items: center;
            background: rgba(129, 140, 248, 0.1);
            border-color: var(--periwinkle); cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .panel-box.minimized .panel-header h3, 
        .panel-box.minimized .panel-content { display: none; opacity: 0; }
        
        .panel-box.minimized .panel-header {
            margin: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }

        .panel-header {
            display: flex; justify-content: space-between; align-items: center; width: 100%;
        }

        .panel-header h3 {
            font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
            text-transform: uppercase; letter-spacing: 0.4em; color: var(--periwinkle);
            text-shadow: 0 0 10px rgba(129, 140, 248, 0.3);
        }
        
        .minimize-btn {
            background: transparent; border: none; color: var(--periwinkle);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            padding: 4px; transition: all 0.2s;
        }
        .minimize-btn:hover { transform: scale(1.1); text-shadow: 0 0 8px currentColor; }

        /* --- Settings Module (Morphing) --- */
        #settings-module {
            position: fixed; top: 32px; left: 32px; z-index: 300;
            background: var(--panel-bg);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(129, 140, 248, 0.2);
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        height 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                        transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), 
                        border-radius 0.3s ease;
            width: 56px; height: 56px; /* Collapsed size */
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform-origin: center;
        }

        /* Default Corners: Top-Right / Bottom-Left */
        #settings-module::before, #settings-module::after {
            content: ""; position: absolute; width: 12px; height: 12px;
            border-color: var(--periwinkle); border-style: solid; pointer-events: none; opacity: 0.8;
            transition: all 0.3s;
        }
        
        /* Collapsed Corners: Top Right & Bottom Left */
        #settings-module:not(.expanded)::before { 
            top: -1px; right: -1px; left: auto; bottom: auto;
            border-width: 2px 2px 0 0; 
        }
        #settings-module:not(.expanded)::after { 
            bottom: -1px; left: -1px; right: auto; top: auto;
            border-width: 0 0 2px 2px; 
        }

        /* Expanded Corners: Top Left & Bottom Right */
        #settings-module.expanded::before { 
            top: -1px; left: -1px; right: auto; bottom: auto;
            border-width: 2px 0 0 2px; 
        }
        #settings-module.expanded::after { 
            bottom: -1px; right: -1px; left: auto; top: auto;
            border-width: 0 2px 2px 0; 
        }

        /* Hover on collapsed module: Box rotates Left (-90) */
        #settings-module:not(.expanded):hover {
            transform: rotate(-90deg);
            border-color: var(--periwinkle);
            box-shadow: 0 0 25px rgba(129, 140, 248, 0.4);
        }
        
        /* Hover on collapsed: Gear rotates Right (+90 visual result) */
        #settings-module:not(.expanded):hover #gear-icon {
            transform: translate(-50%, -50%) rotate(180deg); 
        }

        #gear-icon {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 28px; height: 28px;
            color: #94a3b8;
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1), opacity 0.2s, color 0.3s;
            pointer-events: none;
        }

        #settings-module.expanded {
            width: 340px; height: auto;
            cursor: default;
            transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), 
                        height 0.4s cubic-bezier(0.34, 1.56, 0.64, 1),
                        border-radius 0.3s ease;
            transform: rotate(0deg) !important;
            border-color: rgba(129, 140, 248, 0.5);
        }

        #settings-module.expanded #gear-icon {
            animation: gear-spin-fade 0.4s forwards;
        }

        @keyframes gear-spin-fade {
            0% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
            100% { transform: translate(-50%, -50%) rotate(360deg); opacity: 0; }
        }
        
        #settings-module:not(.expanded) #gear-icon.sprouting {
            animation: gear-sprout 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes gear-sprout {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); opacity: 0; }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); opacity: 1; }
        }

        #settings-content {
            padding: 32px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease 0.1s;
            display: flex; flex-direction: column; gap: 20px;
        }

        #settings-module.expanded #settings-content {
            opacity: 1;
            pointer-events: auto;
        }

        /* --- Ratio HUD (Top Right) --- */
        #ratio-hud {
            position: fixed;
            top: 40px; right: 40px;
            text-align: right;
            pointer-events: none;
            z-index: 150;
            opacity: 0;
            transition: opacity 1s ease-out;
        }
        
        #ratio-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 4rem;
            font-weight: 800;
            color: var(--white);
            text-shadow: 0 0 30px var(--periwinkle);
            letter-spacing: -0.05em;
            line-height: 1;
        }

        /* --- Generic UI Elements --- */
        .hud-btn {
            background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08);
            color: #94a3b8; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem;
            padding: 14px; border-radius: 1px; transition: all 0.3s;
            text-transform: uppercase; letter-spacing: 0.2em; position: relative;
        }
        .hud-btn:hover { background: rgba(129, 140, 248, 0.08); color: #f1f5f9; border-color: rgba(129, 140, 248, 0.4); }
        .hud-btn.active {
            background: rgba(129, 140, 248, 0.15); border-color: var(--periwinkle);
            color: var(--periwinkle); box-shadow: 0 0 20px rgba(129, 140, 248, 0.2);
            text-shadow: 0 0 10px var(--periwinkle);
        }

        input[type=range] {
            -webkit-appearance: none; background: rgba(255, 255, 255, 0.1);
            height: 2px; border-radius: 0; width: 100%;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 6px;
            background: var(--periwinkle); cursor: pointer;
            box-shadow: 0 0 15px var(--periwinkle);
        }

        /* Start Screen */
        #start-overlay { background: var(--void-bg); z-index: 1000; }
        #start-overlay h1 { font-family: 'JetBrains Mono', monospace; letter-spacing: 0.6em; text-shadow: 0 0 60px rgba(129, 140, 248, 0.5); }
        #start-btn {
            font-family: 'JetBrains Mono', monospace; letter-spacing: 0.6em;
            text-transform: uppercase; border: 2px solid var(--periwinkle);
            background: transparent; padding: 1.5rem 5rem; font-size: 0.9rem;
            position: relative; overflow: hidden; transition: all 0.5s; color: var(--periwinkle);
        }
        #start-btn:hover { background: var(--periwinkle); color: #000; box-shadow: 0 0 80px var(--periwinkle); }

        .terminal-toast { border-left: 3px solid var(--periwinkle); padding-left: 1.5rem; font-family: 'JetBrains Mono', monospace; }
        .warning-frame {
            border: 2px solid #ff0055; background: rgba(20, 0, 5, 0.95);
            box-shadow: 0 0 60px rgba(255, 0, 85, 0.4); animation: glitch-border 0.15s infinite alternate;
        }
        @keyframes glitch-border {
            0% { border-color: #ff0055; transform: scale(1); }
            100% { border-color: #ff6a00; transform: scale(1.02); }
        }

        .node-label {
            font-family: 'JetBrains Mono', monospace; font-size: 11px; letter-spacing: 0.1em;
            text-transform: uppercase; pointer-events: none; color: #64748b; 
        }

        select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='none' stroke='%23818cf8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m3 5 3 3 3-3'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 1rem center;
        }
    </style>
</head>
<body class="aberration-active">

    <div id="peripheral-overlay" class="active"></div>

    <!-- Start Overlay -->
    <div id="start-overlay" class="fixed inset-0 flex flex-col items-center justify-center transition-all duration-1000">
        <div class="mb-6 opacity-40 text-[11px] tracking-[1.2em] font-mono text-indigo-300">Created by Garrett Valentine</div>
        <h1 class="text-4xl md:text-7xl font-light mb-20 text-white text-center">JASPEARL <span class="font-bold">HARMONEER</span></h1>
        <button id="start-btn" class="transition-all duration-700 hover:scale-110">
            INITIATE
        </button>
    </div>

    <!-- Startup Guide -->
    <div id="startup-toast" class="fixed top-1/4 left-1/2 -translate-x-1/2 hud-panel bottom-panel p-12 shadow-2xl opacity-0 pointer-events-none transition-opacity duration-1000 z-50">
        <div class="terminal-toast">
            <p class="text-[10px] uppercase tracking-[0.6em] text-indigo-400 mb-8 font-bold">// Controls</p>
            <div class="text-[12px] space-y-5 text-slate-400 uppercase tracking-[0.3em]">
                <p><span class="text-white">PIVOT</span> using the arrows or &lt; / &gt;</p>
                <p><span class="text-white">SELECT</span> using the spacebar</p>
                <p><span class="text-white">TOGGLE</span> B / D / S</p>
            </div>
        </div>
    </div>

    <!-- Dimension Warning -->
    <div id="dimension-warning" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-none z-[200] opacity-0 scale-90 transition-all duration-700">
        <div class="warning-frame px-16 py-8 text-center">
            <div class="font-mono text-2xl font-bold uppercase tracking-[0.4em] text-red-500">⚠️SPECTRAL SHIFT⚠️</div>
            <div class="text-red-400 text-[9px] tracking-[0.7em] uppercase mt-4 font-bold opacity-80">ACCESSING HIGHER DIMENSIONAL LATTICE</div>
        </div>
    </div>

    <!-- Ratio HUD -->
    <div id="ratio-hud">
        <div id="ratio-display">1/1</div>
    </div>
    
    <!-- Settings Module (Top Left) -->
    <div id="settings-module">
        <div id="gear-icon">
            <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
        </div>
        <div id="settings-content">
            <div class="flex flex-col gap-3">
                <span class="text-[9px] uppercase tracking-[0.4em] text-slate-500 font-bold">SYSTEM VOLUME</span>
                <input type="range" id="master-vol" min="0" max="1" step="0.01" value="0.3">
            </div>
            <div class="flex items-center justify-between">
                <span class="text-[9px] uppercase tracking-[0.4em] text-slate-500 font-bold">PERIPHERAL</span>
                <button id="vignette-toggle" class="text-[10px] px-5 py-2 border border-indigo-500/40 text-indigo-400 font-bold uppercase tracking-widest bg-indigo-500/10">On</button>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-[9px] uppercase tracking-[0.4em] text-slate-500 font-bold">RATIO HUD</span>
                <button id="ratio-toggle" class="text-[10px] px-5 py-2 border border-indigo-500/40 text-indigo-400 font-bold uppercase tracking-widest bg-indigo-500/10">On</button>
            </div>
            <div class="h-px bg-indigo-500/20"></div>
            <div class="flex flex-col gap-3">
                <span class="text-[9px] uppercase tracking-[0.4em] text-slate-500 font-bold">WAVEFORM</span>
                <select id="preset-select" class="w-full bg-slate-900/80 border border-indigo-500/30 text-[11px] p-4 rounded-none outline-none text-slate-300 font-mono tracking-[0.2em] uppercase">
                    <option value="sine" selected>SINE</option>
                    <option value="triangle">TRIANGLE</option>
                    <option value="square">SQUARE</option>
                    <option value="sawtooth">SAWTOOTH</option>
                    <option value="rich_pad">RICH PAD</option>
                    <option value="hyper_saw">HYPER SAW</option>
                    <option value="analog_strings">ANALOG STRINGS</option>
                    <option value="glass_pad">GLASS PAD</option>
                    <option value="deep_pulse">DEEP PULSE</option>
                </select>
            </div>
        </div>
    </div>

    <!-- UI HUD Panels (Bottom) -->
    <div id="ui-layer">
        <div class="panel-box hud-panel bottom-panel minimized" id="sound-panel">
            <div class="panel-header">
                <h3>Synth</h3>
                <button class="minimize-btn" title="Toggle Panel">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>
                </button>
            </div>
            <div class="panel-content flex gap-12">
                <div class="flex flex-col gap-6 flex-1 min-w-[180px]">
                    <div class="flex flex-col gap-3">
                        <div class="flex justify-between items-center"><label class="text-[9px] uppercase tracking-[0.3em] text-slate-500 font-bold">Attack</label></div>
                        <input type="range" id="atk-slider" min="0.01" max="2" step="0.01" value="0.05">
                    </div>
                    <div class="flex flex-col gap-3">
                        <div class="flex justify-between items-center"><label class="text-[9px] uppercase tracking-[0.3em] text-slate-500 font-bold">Decay</label></div>
                        <input type="range" id="dec-slider" min="0.1" max="4" step="0.1" value="0.5">
                    </div>
                    <div class="flex flex-col gap-3">
                        <div class="flex justify-between items-center"><label class="text-[9px] uppercase tracking-[0.3em] text-slate-500 font-bold">Glide [Drone]</label></div>
                        <input type="range" id="drone-glide" min="0" max="250" step="1" value="125">
                    </div>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <button id="sustain-btn" class="hud-btn">Sustain</button>
                    <button id="bass-btn" class="hud-btn">Bass</button>
                    <button id="drone-btn" class="hud-btn">Drone</button>
                </div>
            </div>
        </div>

        <div class="panel-box hud-panel bottom-panel minimized" id="chord-panel">
            <div class="panel-header">
                <h3>Chords</h3>
                <button class="minimize-btn" title="Toggle Panel">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>
                </button>
            </div>
            <div class="panel-content">
                <div class="grid grid-cols-3 gap-4">
                    <button class="hud-btn active" data-key="1">Maj</button>
                    <button class="hud-btn" data-key="2">Min</button>
                    <button class="hud-btn" data-key="3">P5</button>
                    <button class="hud-btn" data-key="q">Maj7</button>
                    <button class="hud-btn" data-key="w">Min7</button>
                    <button class="hud-btn" data-key="e">H7</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Canvas -->
    <div id="canvas-container">
        <svg id="main-svg" style="width:100%; height:100%; overflow: visible;" preserveAspectRatio="xMidYMid slice">
            <g id="world-group" style="overflow: visible;">
                <g id="grid-lines"></g>
                <g id="grid-nodes"></g>
                <g id="ghost-cursor-group" style="display: none;">
                    <line id="extrusion-line" x1="0" y1="0" x2="0" y2="0" stroke="var(--white)" stroke-width="1" stroke-dasharray="4 4"></line>
                    <circle id="ghost-cursor-circle" r="22" fill="rgba(129, 140, 248, 0.05)" stroke="var(--white)" stroke-width="1.5" stroke-dasharray="2 4"></circle>
                </g>
                <g id="special-nodes"></g> 
            </g>
        </svg>
    </div>

    <script>
        /* --- DOM REFERENCES --- */
        const container = document.getElementById('canvas-container');
        const worldGroup = document.getElementById('world-group');
        const nodesG = document.getElementById('grid-nodes');
        const linesG = document.getElementById('grid-lines');
        const specialNodesG = document.getElementById('special-nodes');
        const ghostGroup = document.getElementById('ghost-cursor-group');
        const extrusionLine = document.getElementById('extrusion-line');
        const ratioHud = document.getElementById('ratio-hud');
        const ratioDisplay = document.getElementById('ratio-display');

        /* --- CONSTANTS & CONFIG --- */
        const SPACING_X = 120;
        const SPACING_Y = 120; 
        const Z_OFFSET_X = 30;
        const Z_OFFSET_Y = -20;
        const BASE_FREQ = 261.63; 
        const RATIO_X = 1.5; 
        const RATIO_Y = 1.25; 
        const RATIO_Z = 1.75; 
        const RENDER_BUFFER = 1000; 

        const CHORD_TYPES = {
            '1': { name: 'Major', shape: [{dx:0,dy:0,dz:0}, {dx:1,dy:0,dz:0}, {dx:0,dy:1,dz:0}] },
            '2': { name: 'Minor', shape: [{dx:0,dy:0,dz:0}, {dx:1,dy:0,dz:0}, {dx:1,dy:-1,dz:0}] },
            '3': { name: 'Power', shape: [{dx:0,dy:0,dz:0}, {dx:1,dy:0,dz:0}] },
            'q': { name: 'Maj 7', shape: [{dx:0,dy:0,dz:0}, {dx:1,dy:0,dz:0}, {dx:0,dy:1,dz:0}, {dx:1,dy:1,dz:0}] },
            'w': { name: 'Min 7', shape: [{dx:0,dy:0,dz:0}, {dx:1,dy:0,dz:0}, {dx:1,dy:-1,dz:0}, {dx:2,dy:-1,dz:0}] },
            'e': { name: 'Dom 7', shape: [{dx:0,dy:0,dz:0}, {dx:1,dy:0,dz:0}, {dx:0,dy:1,dz:0}, {dx:0,dy:0,dz:1}] } 
        };
        
        const SYNTH_PRESETS = {
            'sine': { type: 'simple', sine: 1 },
            'triangle': { type: 'simple', triangle: 1 },
            'square': { type: 'simple', square: 1 },
            'sawtooth': { type: 'simple', sawtooth: 1 },
            'rich_pad': { type: 'rich_pad', gainMod: 0.2 },
            'hyper_saw': { type: 'hyper_saw', gainMod: 0.15 },
            'analog_strings': { type: 'analog_strings', gainMod: 0.25 },
            'glass_pad': { type: 'glass_pad', gainMod: 0.3 },
            'deep_pulse': { type: 'deep_pulse', gainMod: 0.2 }
        };

        const APPROX_NOTE_LABELS = [
            "C", "C<span class='half-sharp'>‡</span>", "C♯", "D<span class='back-flat'>♭</span>", 
            "D", "D<span class='half-sharp'>‡</span>", "E♭", "E<span class='back-flat'>♭</span>", 
            "E", "F<span class='back-flat'>♭</span>", "F", "F<span class='half-sharp'>‡</span>", 
            "F♯", "G<span class='back-flat'>♭</span>", "G", "G<span class='half-sharp'>‡</span>", 
            "G♯", "A<span class='back-flat'>♭</span>", "A", "A<span class='half-sharp'>‡</span>", 
            "B♭", "B<span class='back-flat'>♭</span>", "B", "B<span class='half-sharp'>‡</span>"
        ];

        const state = {
            audioCtx: null, gainNode: null, isAudioStarted: false,
            activeVoices: new Map(),
            viewX: -window.innerWidth / 2, viewY: -window.innerHeight / 2 + 50, 
            targetViewX: -window.innerWidth / 2, targetViewY: -window.innerHeight / 2 + 50,
            zoom: 1.5, targetZoom: 1.5,
            lastRenderX: -99999, lastRenderY: -99999, lastRenderZoom: 0,
            lastRenderZ: -999, lastRenderCursorZ: -999,
            hasFlashedGhost: false, nodeCache: new Map(), lineCache: new Map(),
            cursor: { x: 0, y: 0, z: 0 }, visualCursor: { x: 0, y: 0 }, playedRoot: { x: 0, y: 0, z: 0 },
            referenceRoot: { x: 0, y: 0, z: 0 },
            attack: 0.05, decay: 0.5, sustain: false, bassEnabled: false, droneEnabled: false,
            droneGlideTime: 0.125, droneCurrentFreq: null, peripheralEnabled: true, ratioEnabled: true, masterVol: 0.3,
            synthMix: { ...SYNTH_PRESETS['sine'] },
            currentChordKey: '1', isDragging: false, lastMouse: { x: 0, y: 0 },
            ratioFadeTimeout: null, hasOpenedPanels: false
        };

        /* --- RENDERING --- */
        function renderGridContent() {
            state.lastRenderZ = state.playedRoot.z; 
            state.lastRenderCursorZ = state.cursor.z; state.lastRenderX = state.viewX; state.lastRenderY = state.viewY;
            const buffer = RENDER_BUFFER / state.zoom;
            const l = state.viewX - (window.innerWidth/(2*state.zoom)) - buffer;
            const r = state.viewX + (window.innerWidth/(2*state.zoom)) + buffer;
            const t = state.viewY - (window.innerHeight/(2*state.zoom)) - buffer;
            const b = state.viewY + (window.innerHeight/(2*state.zoom)) + buffer;
            const activeZ = state.playedRoot.z; const ghostZ = state.cursor.z;
            const planes = [...new Set([activeZ, ghostZ])];
            const visible = new Set();
            const visibleLines = new Set();

            planes.forEach(z => {
                const c1 = getGridCoords(l, t, z); const c2 = getGridCoords(r, b, z);
                const startX = Math.floor(Math.min(c1.x, c2.x));
                const endX = Math.ceil(Math.max(c1.x, c2.x));
                const startY = Math.floor(Math.min(c1.y, c2.y));
                const endY = Math.ceil(Math.max(c1.y, c2.y));

                for (let y = startY; y <= endY; y++) {
                    for (let x = startX; x <= endX; x++) {
                        const id = `node_${x}_${y}_${z}`; visible.add(id);
                        if (!state.nodeCache.has(id)) {
                            createNode(x, y, z, nodesG);
                        }
                        const lh = `line_${x}_${y}_${z}_h`; const lv = `line_${x}_${y}_${z}_v`;
                        visibleLines.add(lh); visibleLines.add(lv);
                        if (!state.lineCache.has(lh)) createLine(x, y, z, x+1, y, z, 'h', linesG);
                        if (!state.lineCache.has(lv)) createLine(x, y, z, x, y+1, z, 'v', linesG);
                    }
                }
            });
            
            if (ghostZ !== activeZ && !state.hasFlashedGhost) {
                state.hasFlashedGhost = true;
                const w = document.getElementById('dimension-warning');
                w.style.opacity = '1'; w.style.transform = 'translate(-50%, -50%) scale(1)';
                setTimeout(() => { w.style.opacity = '0'; w.style.transform = 'translate(-50%, -50%) scale(0.9)'; }, 3000);
            }

            for (const [id, el] of state.nodeCache) {
                if (!visible.has(id)) { el.remove(); state.nodeCache.delete(id); }
                else el.classList.toggle('ghost-plane', parseInt(id.split('_')[3]) !== activeZ);
            }
            for (const [id, el] of state.lineCache) {
                if (!visibleLines.has(id)) { el.remove(); state.lineCache.delete(id); }
                else el.classList.toggle('ghost-plane', parseInt(id.split('_')[3]) !== activeZ);
            }

            updateVisuals();
        }

        /* --- AUDIO & SYSTEM INIT --- */
        function initAudio() {
            if (state.isAudioStarted) return;
            const AC = window.AudioContext || window.webkitAudioContext;
            state.audioCtx = new AC();
            const compressor = state.audioCtx.createDynamicsCompressor();
            compressor.threshold.setValueAtTime(-12, state.audioCtx.currentTime);
            state.gainNode = state.audioCtx.createGain();
            state.gainNode.gain.value = state.masterVol;
            state.gainNode.connect(compressor);
            compressor.connect(state.audioCtx.destination);
            state.isAudioStarted = true;
            
            document.getElementById('start-overlay').style.opacity = '0';
            document.getElementById('start-overlay').style.pointerEvents = 'none';
            setTimeout(() => document.getElementById('start-overlay').remove(), 1000);
            
            const toast = document.getElementById('startup-toast');
            toast.style.opacity = '1';
            setTimeout(() => toast.style.opacity = '0', 6000);
            
            // Auto-expand panels AFTER toast disappears (6500ms)
            if (!state.hasOpenedPanels) {
                setTimeout(() => {
                    document.querySelectorAll('.panel-box.minimized').forEach(p => {
                        p.classList.remove('minimized');
                        const btn = p.querySelector('.minimize-btn');
                        if (btn) btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>';
                    });
                    state.hasOpenedPanels = true;
                    centerCameraOnChord(); 
                }, 6500); 
            }
            
            state.visualCursor = getScreenCoords(state.cursor.x, state.cursor.y, state.cursor.z);
            renderGridContent(); 
            requestAnimationFrame(animate); 
            updateVisuals(); 
            centerCameraOnChord();
        }

        /* --- HELPERS --- */
        function getFrequency(x, y, z) {
            let ratio = Math.pow(RATIO_X, x) * Math.pow(RATIO_Y, y) * Math.pow(RATIO_Z, z);
            while (ratio < 1) ratio *= 2; while (ratio >= 2) ratio /= 2;
            return BASE_FREQ * ratio; 
        }

        function getNoteLabelHTML(x, y, z) {
            const cents = (x * 701.955) + (y * 386.314) + (z * 968.826);
            const index = Math.round((((cents % 1200) + 1200) % 1200) / 50) % 24;
            return APPROX_NOTE_LABELS[index];
        }

        function getNoteHue(x, y, z) {
            const cents = (x * 701.955) + (y * 386.314) + (z * 968.826);
            const index = Math.round((((cents % 1200) + 1200) % 1200) / 50) % 24; 
            return (index - 16) * 15;
        }

        function getRatioString(x, y, z) {
            let num = 1; let den = 1;
            if (x > 0) num *= Math.pow(3, x); else if (x < 0) den *= Math.pow(3, Math.abs(x));
            if (y > 0) num *= Math.pow(5, y); else if (y < 0) den *= Math.pow(5, Math.abs(y));
            if (z > 0) num *= Math.pow(7, z); else if (z < 0) den *= Math.pow(7, Math.abs(z));
            let ratio = num / den;
            while (ratio < 1) { ratio *= 2; num *= 2; }
            while (ratio >= 2) { ratio /= 2; den *= 2; }
            const gcd = (a, b) => b ? gcd(b, a % b) : a;
            const common = gcd(num, den);
            return `${num/common}/${den/common}`;
        }

        function showRatio(newRoot) {
            if (!state.ratioEnabled) return;
            const dx = newRoot.x - state.referenceRoot.x;
            const dy = newRoot.y - state.referenceRoot.y;
            const dz = newRoot.z - state.referenceRoot.z;
            if (dx === 0 && dy === 0 && dz === 0) return;

            const rStr = getRatioString(dx, dy, dz);
            ratioDisplay.textContent = rStr;
            ratioHud.style.opacity = '1';
            
            if (state.ratioFadeTimeout) clearTimeout(state.ratioFadeTimeout);
            state.ratioFadeTimeout = setTimeout(() => {
                ratioHud.style.opacity = '0';
            }, 4000);

            state.referenceRoot = { ...newRoot };
        }

        function createVoice(freq, startTime, isDrone = false) {
            const ctx = state.audioCtx; const mix = state.synthMix;
            const gain = ctx.createGain(); const att = mix.attack || parseFloat(state.attack);
            gain.gain.setValueAtTime(0, startTime);
            gain.gain.linearRampToValueAtTime(mix.gainMod || 0.3, startTime + att);
            let outputNode = gain; let oscs = [];

            if (mix.type === 'rich_pad') {
                const f = ctx.createBiquadFilter(); f.type = "bandpass"; f.frequency.value = 750;
                gain.connect(f); outputNode = f;
                const o1 = ctx.createOscillator(); o1.type = 'sawtooth'; o1.frequency.value = freq;
                o1.connect(gain); o1.start(startTime); oscs.push(o1);
            } else if (mix.type === 'hyper_saw') {
                [0, 8, -8].forEach(detune => {
                    const o = ctx.createOscillator(); o.type = 'sawtooth'; o.frequency.value = freq; o.detune.value = detune;
                    o.connect(gain); o.start(startTime); oscs.push(o);
                });
            } else {
                ['sine','triangle','square','sawtooth'].forEach(type => {
                    if (mix[type] > 0) {
                        const o = ctx.createOscillator(); o.type = type; o.frequency.value = freq;
                        const g = ctx.createGain(); g.gain.value = mix[type];
                        o.connect(g); g.connect(gain); o.start(startTime); oscs.push(o);
                    }
                });
            }

            if (isDrone) {
                const lp = ctx.createBiquadFilter(); lp.type = "lowpass"; lp.frequency.value = 400; lp.Q.value = 4;
                outputNode.disconnect(); outputNode.connect(lp); outputNode = lp;
            }
            outputNode.connect(state.gainNode);
            return { oscs, gain };
        }

        function playTone(id, freq, options = {}) {
            if (!state.audioCtx) return;
            const ctx = state.audioCtx; if (ctx.state === 'suspended') ctx.resume();
            if (state.activeVoices.has(id)) {
                if (options.slide) {
                    state.activeVoices.get(id).oscs.forEach(o => o.frequency.setTargetAtTime(freq, ctx.currentTime, state.droneGlideTime));
                    return;
                }
                stopTone(id, true);
            }
            const voice = createVoice(freq, ctx.currentTime, id === 'global_drone');
            state.activeVoices.set(id, voice);
            updateVisuals(); 
        }

        function stopTone(id, force = false) {
            if (!state.activeVoices.has(id)) return;
            if (state.sustain && !force && !id.startsWith('bass_') && id !== 'global_drone') return; 
            const voice = state.activeVoices.get(id); const ctx = state.audioCtx;
            let dec = state.synthMix.decay || parseFloat(state.decay);
            voice.gain.gain.cancelScheduledValues(ctx.currentTime);
            voice.gain.gain.setValueAtTime(voice.gain.gain.value, ctx.currentTime);
            voice.gain.gain.linearRampToValueAtTime(0, ctx.currentTime + dec);
            voice.oscs.forEach(osc => osc.stop(ctx.currentTime + dec + 0.1));
            state.activeVoices.delete(id);
            updateVisuals();
        }

        function stopAllTones() {
            for (const [id] of state.activeVoices) if (id !== 'global_drone') stopTone(id, true); 
        }

        function toggleDrone() {
            state.droneEnabled = !state.droneEnabled;
            document.getElementById('drone-btn').classList.toggle('active', state.droneEnabled);
            if (state.droneEnabled && state.isAudioStarted) {
                state.droneCurrentFreq = getFrequency(state.cursor.x, state.cursor.y, state.cursor.z) / 2;
                playTone('global_drone', state.droneCurrentFreq);
            } else {
                stopTone('global_drone', true); state.droneCurrentFreq = null;
            }
        }

        function toggleSustain() {
            state.sustain = !state.sustain;
            document.getElementById('sustain-btn').classList.toggle('active', state.sustain);
            if (!state.sustain) stopAllTones();
        }

        function getScreenCoords(x, y, z) {
            return { x: (x * SPACING_X) + (z * Z_OFFSET_X), y: -(y * SPACING_Y) + (z * Z_OFFSET_Y) };
        }

        function getGridCoords(worldX, worldY, zLevel) {
            const sx = worldX - (zLevel * Z_OFFSET_X);
            const sy = worldY - (zLevel * Z_OFFSET_Y);
            return { x: sx / SPACING_X, y: -sy / SPACING_Y };
        }

        function animate() {
            state.zoom += (state.targetZoom - state.zoom) * 0.15;
            state.viewX += (state.targetViewX - state.viewX) * 0.12;
            state.viewY += (state.targetViewY - state.viewY) * 0.12;
            const targetPos = getScreenCoords(state.cursor.x, state.cursor.y, state.cursor.z);
            state.visualCursor.x += (targetPos.x - state.visualCursor.x) * 0.2;
            state.visualCursor.y += (targetPos.y - state.visualCursor.y) * 0.2;
            
            const tx = -state.viewX * state.zoom + window.innerWidth / 2;
            const ty = -state.viewY * state.zoom + window.innerHeight / 2;
            worldGroup.setAttribute('transform', `translate(${tx} ${ty}) scale(${state.zoom})`);
            
            ghostGroup.style.display = 'block'; ghostGroup.setAttribute('transform', `translate(${state.visualCursor.x}, ${state.visualCursor.y})`);
            const r = getScreenCoords(state.playedRoot.x, state.playedRoot.y, state.playedRoot.z);
            extrusionLine.setAttribute('x1', r.x - state.visualCursor.x); extrusionLine.setAttribute('y1', r.y - state.visualCursor.y);
            extrusionLine.setAttribute('x2', 0); extrusionLine.setAttribute('y2', 0);
            extrusionLine.style.opacity = state.cursor.z !== state.playedRoot.z ? 0.3 : 0;

            if (Math.hypot(state.viewX - state.lastRenderX, state.viewY - state.lastRenderY) > 50 || 
                state.cursor.z !== state.lastRenderCursorZ ||
                state.playedRoot.z !== state.lastRenderZ) {
                renderGridContent();
            }
            requestAnimationFrame(animate);
        }

        function createNode(x, y, z, container) {
            const p = getScreenCoords(x, y, z);
            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("transform", `translate(${p.x}, ${p.y})`); g.setAttribute("id", `node_${x}_${y}_${z}`);
            const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            c.setAttribute("r", "16"); c.setAttribute("class", "node-circle"); g.appendChild(c);
            
            const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
            fo.setAttribute("x", "-20"); fo.setAttribute("y", "-10"); fo.setAttribute("width", "40"); fo.setAttribute("height", "20");
            
            const d = document.createElement("div"); 
            d.style.width = "100%"; d.style.height = "100%";
            d.style.display = "flex"; d.style.justifyContent = "center"; d.style.alignItems = "center";
            
            const s = document.createElement("span"); s.className = "node-label"; s.innerHTML = getNoteLabelHTML(x,y,z);
            d.appendChild(s); fo.appendChild(d); g.appendChild(fo);
            
            g.onmousedown = (e) => { e.stopPropagation(); state.playedRoot={x,y,z}; state.cursor={x,y,z}; playChord(); centerCameraOnChord(); };
            g.onmouseup = () => { if(!state.sustain) stopAllTones(); };
            container.appendChild(g); state.nodeCache.set(`node_${x}_${y}_${z}`, g);
        }

        function createLine(x1, y1, z1, x2, y2, z2, type, container) {
            const p1 = getScreenCoords(x1, y1, z1); const p2 = getScreenCoords(x2, y2, z2);
            const l = document.createElementNS("http://www.w3.org/2000/svg", "line");
            l.setAttribute("x1", p1.x); l.setAttribute("y1", p1.y); l.setAttribute("x2", p2.x); l.setAttribute("y2", p2.y);
            l.setAttribute("class", "connection-line"); container.appendChild(l);
            state.lineCache.set(`line_${x1}_${y1}_${z1}_${type}`, l);
        }

        // Render special nodes (e.g. 7th harmonic out of plane)
        function renderSpecialNode(x, y, z) {
            const id = `node_special_${x}_${y}_${z}`;
            let g = document.getElementById(id);
            if (!g) {
                const p = getScreenCoords(x, y, z);
                g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("transform", `translate(${p.x}, ${p.y})`); 
                g.setAttribute("id", id);
                g.classList.add('node-special');
                
                const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                c.setAttribute("r", "14"); c.setAttribute("class", "node-circle"); g.appendChild(c);
                
                const fo = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
                fo.setAttribute("x", "-20"); fo.setAttribute("y", "-10"); fo.setAttribute("width", "40"); fo.setAttribute("height", "20");
                const d = document.createElement("div"); 
                d.style.width="100%"; d.style.height="100%"; d.style.display="flex"; d.style.justifyContent="center"; d.style.alignItems="center";
                const s = document.createElement("span"); s.className = "node-label"; s.innerHTML = getNoteLabelHTML(x,y,z);
                d.appendChild(s); fo.appendChild(d); g.appendChild(fo);
                
                specialNodesG.appendChild(g);
                state.nodeCache.set(id, g); // Track it so updateVisuals works
            }
            return id;
        }

        function playChord() {
            const root = state.playedRoot; const chord = CHORD_TYPES[state.currentChordKey].shape;
            const ids = new Set(); 
            
            // Clear old special nodes if any from previous play
            // Simple approach: clear DOM and cache entries for specials
            Array.from(specialNodesG.children).forEach(child => {
                state.nodeCache.delete(child.id);
                child.remove();
            });

            chord.forEach(n => {
                const tx=root.x+n.dx, ty=root.y+n.dy, tz=root.z+(n.dz||0); 
                let id;
                // If it's a "special" node (dz != 0)
                if (n.dz && n.dz !== 0) {
                    id = renderSpecialNode(tx, ty, tz);
                } else {
                    id = `node_${tx}_${ty}_${tz}`;
                }
                playTone(id, getFrequency(tx,ty,tz)); ids.add(id);
            });

            for (const [id] of state.activeVoices) if (id !== 'global_drone' && !ids.has(id)) stopTone(id, true);
            if (state.bassEnabled) playTone('bass_main', getFrequency(root.x, root.y, root.z)/4);
            if (state.droneEnabled) {
                const opts = chord.map(n => getFrequency(root.x+n.dx, root.y+n.dy, root.z+(n.dz||0))/2);
                state.droneCurrentFreq = state.droneCurrentFreq ? opts.reduce((a,b)=>Math.abs(b-state.droneCurrentFreq)<Math.abs(a-state.droneCurrentFreq)?b:a) : opts[0];
                playTone('global_drone', state.droneCurrentFreq, { slide: true });
            }
            
            showRatio(root);
            updateVisuals();
        }

        function updateVisuals() {
            // Reset all nodes
            state.nodeCache.forEach(g => {
                g.classList.remove('node-highlight', 'node-target', 'node-active'); 
                const c = g.querySelector('.node-circle'); 
                if(c) { 
                    c.style.stroke='var(--white)'; 
                    c.style.fill='#010409';
                    c.style.fillOpacity = ''; 
                    c.style.filter = '';
                    c.style.strokeWidth = '';
                    c.style.strokeOpacity = '';
                }
                g.style.color = ''; 
            });
            
            const root = state.playedRoot;
            
            // Highlight Current Chord Shape
            CHORD_TYPES[state.currentChordKey].shape.forEach(n => {
                const tx = root.x + n.dx; const ty = root.y + n.dy; const tz = root.z + (n.dz||0);
                let g = state.nodeCache.get(`node_${tx}_${ty}_${tz}`);
                if (!g && n.dz) g = state.nodeCache.get(`node_special_${tx}_${ty}_${tz}`);

                if(g) {
                    g.classList.add('node-highlight'); 
                    const hue = getNoteHue(tx, ty, tz);
                    const color = `hsl(${hue}, 100%, 65%)`;
                    const c = g.querySelector('.node-circle');
                    if(c) {
                        c.style.stroke = color;
                        c.style.filter = `drop-shadow(0 0 6px ${color})`;
                    }
                    g.style.color = color;
                }
            });

            // Mark Cursor Target
            const target = state.nodeCache.get(`node_${state.cursor.x}_${state.cursor.y}_${state.cursor.z}`);
            if(target) target.classList.add('node-target');

            // Apply "Active" State - Neon Flash
            state.activeVoices.forEach((_, id) => {
                const el = state.nodeCache.get(id);
                if(el) {
                    el.classList.add('node-active');
                    // Parse ID to get coords for color
                    let x, y, z;
                    if (id.startsWith('node_special_')) {
                        const parts = id.split('_');
                        x = parseInt(parts[2]); y = parseInt(parts[3]); z = parseInt(parts[4]);
                    } else {
                        const parts = id.split('_');
                        if(parts.length >= 4) {
                            x = parseInt(parts[1]); y = parseInt(parts[2]); z = parseInt(parts[3]);
                        }
                    }

                    if (x !== undefined) {
                        const hue = getNoteHue(x, y, z);
                        const color = `hsl(${hue}, 100%, 60%)`;
                        el.style.color = color; 
                    }
                }
            });
        }

        function centerCameraOnChord() {
            // Calculate Centroid of the active chord shape
            const shape = CHORD_TYPES[state.currentChordKey].shape;
            let sumX = 0, sumY = 0, count = 0;
            shape.forEach(n => {
                // We use all nodes including dz for centroid, assuming projection
                sumX += n.dx; 
                sumY += n.dy; 
                count++;
            });
            const avgX = count ? sumX / count : 0;
            const avgY = count ? sumY / count : 0;

            const pos = getScreenCoords(state.playedRoot.x + avgX, state.playedRoot.y + avgY, state.playedRoot.z);
            
            // Check if CHORD panel is open (not minimized)
            const chordPanelOpen = !document.querySelector('#chord-panel').classList.contains('minimized');
            
            state.targetViewX = pos.x; 
            // Move camera UP means subtracting Y (or adding positive offset to target if Y inverted)
            // Actually, to move content UP, we increase viewY (camera goes down).
            // User requested: "up a bit when the bottom tabs are open".
            // So if open -> shift content up -> camera moves down -> larger Y.
            state.targetViewY = pos.y + (chordPanelOpen ? 120 : 20); 
        }

        function setChordType(key) {
            state.currentChordKey = key;
            document.querySelectorAll('.hud-btn').forEach(b => b.classList.toggle('active', b.dataset.key === key));
            updateVisuals(); centerCameraOnChord(); 
        }

        /* --- Settings Module Logic --- */
        const settingsModule = document.getElementById('settings-module');
        const gearIcon = document.getElementById('gear-icon');
        let hoverTimeout;

        settingsModule.addEventListener('click', (e) => {
            if (e.target.closest('#settings-content')) return; 
            if (!settingsModule.classList.contains('expanded')) {
                settingsModule.classList.add('expanded');
            }
        });

        settingsModule.addEventListener('mouseleave', () => {
            clearTimeout(hoverTimeout);
            hoverTimeout = setTimeout(() => {
                if (settingsModule.classList.contains('expanded')) {
                    settingsModule.classList.remove('expanded');
                    gearIcon.classList.remove('sprouting');
                    void gearIcon.offsetWidth; 
                    gearIcon.classList.add('sprouting');
                }
            }, 300);
        });

        settingsModule.addEventListener('mouseenter', () => {
            clearTimeout(hoverTimeout);
        });

        document.getElementById('vignette-toggle').onclick = (e) => {
            state.peripheralEnabled = !state.peripheralEnabled;
            e.target.innerText = state.peripheralEnabled ? "On" : "Off";
            document.getElementById('peripheral-overlay').classList.toggle('active', state.peripheralEnabled);
        };
        
        document.getElementById('ratio-toggle').onclick = (e) => {
            state.ratioEnabled = !state.ratioEnabled;
            e.target.innerText = state.ratioEnabled ? "On" : "Off";
        };

        document.getElementById('master-vol').oninput = e => state.masterVol = e.target.value;
        document.getElementById('atk-slider').oninput = e => state.attack = e.target.value;
        document.getElementById('dec-slider').oninput = e => state.decay = e.target.value;
        document.getElementById('drone-glide').oninput = e => state.droneGlideTime = e.target.value / 1000;
        document.getElementById('bass-btn').onclick = e => {
            state.bassEnabled = !state.bassEnabled;
            e.target.classList.toggle('active', state.bassEnabled);
            if (!state.bassEnabled) stopTone('bass_main', true);
        };
        document.getElementById('drone-btn').onclick = toggleDrone;
        document.getElementById('sustain-btn').onclick = toggleSustain;
        
        document.querySelectorAll('.minimize-btn').forEach(btn => btn.onclick = e => {
            e.stopPropagation();
            const p = e.currentTarget.closest('.panel-box'); 
            p.classList.toggle('minimized');
            e.currentTarget.innerHTML = p.classList.contains('minimized') ? 
                '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>' : 
                '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>';
            centerCameraOnChord(); 
        });

        document.querySelectorAll('.panel-box').forEach(panel => {
            panel.addEventListener('click', (e) => {
                if(panel.classList.contains('minimized')) {
                    panel.classList.remove('minimized');
                    const btn = panel.querySelector('.minimize-btn');
                    btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14"/></svg>';
                    centerCameraOnChord();
                }
            });
        });

        document.getElementById('preset-select').onchange = e => state.synthMix = SYNTH_PRESETS[e.target.value];
        document.getElementById('start-btn').onclick = initAudio;

        window.addEventListener('keydown', e => {
            if (!state.isAudioStarted) return;
            const k = e.key.toLowerCase();
            if (CHORD_TYPES[k]) setChordType(k);
            if (k === 'b') { state.bassEnabled = !state.bassEnabled; document.getElementById('bass-btn').classList.toggle('active', state.bassEnabled); }
            if (k === 'd') toggleDrone(); if (k === 's') toggleSustain();
            if (e.key === '.' || e.key === '>') { state.cursor.z++; } 
            if (e.key === ',' || e.key === '<') { state.cursor.z--; } 
            if (e.key === 'ArrowUp') state.cursor.y++; if (e.key === 'ArrowDown') state.cursor.y--;
            if (e.key === 'ArrowRight') state.cursor.x++; if (e.key === 'ArrowLeft') state.cursor.x--;
            if (e.code === 'Space') { e.preventDefault(); state.playedRoot = {...state.cursor}; playChord(); centerCameraOnChord(); }
            updateVisuals();
        });

        window.addEventListener('keyup', e => { if (e.code === 'Space' && !state.sustain) stopAllTones(); });
        
        container.addEventListener('mousedown', e => { state.isDragging = true; state.lastMouse = { x: e.clientX, y: e.clientY }; });
        window.addEventListener('mousemove', e => { if (state.isDragging) { state.targetViewX -= (e.clientX - state.lastMouse.x) / state.zoom; state.targetViewY -= (e.clientY - state.lastMouse.y) / state.zoom; state.lastMouse = { x: e.clientX, y: e.clientY }; } });
        window.addEventListener('mouseup', () => state.isDragging = false);
        container.addEventListener('wheel', e => { e.preventDefault(); state.targetZoom = Math.max(1.1, Math.min(state.targetZoom - e.deltaY * 0.001, 2.8)); }, { passive: false });
    </script>
</body>
</html>
